# AI Trading Firm Configuration
# ================================
#
# CONFIGURATION GUIDE:
# ====================
# This file is organized into sections:
#   - SAFE TO MODIFY: Settings you can change without risk
#   - REVIEW CAREFULLY: Settings that affect trading behavior
#   - ADVANCED/DANGEROUS: Settings that require expertise
#
# For first-time setup, only these 3 settings are REQUIRED:
#   1. broker.port (4002 for paper, see comment)
#   2. firm.mode (keep as "paper" until ready)
#   3. transaction_reporting.firm_lei (get from gleif.org for production)


# =============================================================================
# === SAFE TO MODIFY - Basic Setup ===
# =============================================================================

firm:
  name: "AI Trading Firm"
  version: "1.0.0"
  # SAFE: Trading mode - keep "paper" for testing
  mode: "paper"  # paper | live (NEVER change to live without explicit authorization)

# Interactive Brokers Configuration
# SAFE TO MODIFY: Connection settings
# VALIDATION: Ensure IB Gateway/TWS is running before starting
broker:
  host: "127.0.0.1"               # [string] IB host (usually localhost)
  # REQUIRED: Set your IB port - MUST match your IB Gateway/TWS config
  # Valid values and their meanings:
  #   4002 = IB Gateway Paper Trading (RECOMMENDED for beginners)
  #   4001 = IB Gateway Live Trading (DANGEROUS - real money!)
  #   7497 = TWS Paper Trading
  #   7496 = TWS Live Trading (DANGEROUS - real money!)
  port: 4002                      # [int, 4001|4002|7496|7497] IB API port
  client_id: 10                   # [int, 1-32] Unique client ID (each app needs different ID)
  timeout_seconds: 30             # [int, 10-120] Connection timeout
  readonly: false                 # [bool] If true, cannot place orders
  # SAFE: Use delayed data (free, no subscription needed)
  use_delayed_data: true          # [bool] Use delayed market data (15-20 min delay)

# =============================================================================
# === ADVANCED - Event System (usually no changes needed) ===
# =============================================================================

# Event Bus Configuration
event_bus:
  max_queue_size: 10000
  signal_timeout_seconds: 5.0
  sync_barrier_timeout_seconds: 10.0

  # Quorum-based barrier configuration (Phase A improvement)
  # Releases barrier when quorum threshold of agents respond within fast_path
  quorum:
    enabled: true
    threshold: 0.6                    # [float, 0.5-1.0] Release when 60% of agents respond (was 0.8 - too strict with symbol-filtering agents)
    fast_path_timeout_ms: 500         # [int, 50-500] Fast path timeout in ms (was 100 - too fast for HMM/Kalman agents)
    require_critical: true            # [bool] All CRITICAL agents must respond

  # Agent criticality levels for quorum
  # CRITICAL = must respond, HIGH = preferred, NORMAL = can skip if quorum met
  agent_criticality:
    MacroAgent: high              # Not critical: depends on stock data (unavailable outside US market hours)
    RiskAgent: critical
    MomentumAgent: high
    StatArbAgent: high
    MACDvAgent: high
    TTMSqueezeAgent: high
    IndexSpreadAgent: normal
    SessionAgent: normal
    EventDrivenAgent: normal
    MeanReversionAgent: normal
    MarketMakingAgent: normal
    SentimentAgent: normal
    ChartAnalysisAgent: normal
    ForecastingAgent: normal

  # Per-agent timeout configuration (Phase A improvement)
  agent_timeouts_ms:
    MacroAgent: 300                   # [int] HMM computation takes longer
    SentimentAgent: 500               # [int] LLM agents need more time
    ChartAnalysisAgent: 500           # [int] Vision API latency
    ForecastingAgent: 500             # [int] LLM forecasting
    default: 200                      # [int] Default for all other agents

# Orchestrator Configuration
orchestrator:
  market_data_interval_seconds: 1.0
  heartbeat_interval_seconds: 30.0
  shutdown_timeout_seconds: 60.0

# Dashboard Configuration (Real-time monitoring UI)
# The dashboard provides a WebSocket-based real-time view of trading activity
dashboard:
  enabled: true                       # [bool] Enable/disable dashboard server
  host: "0.0.0.0"                     # [string] Host to bind (0.0.0.0 for all interfaces)
  port: 8081                          # [int] Dashboard port (different from health check port 8080)

# Historical Data Warmup Configuration
# Fetches historical bars on startup so agents can generate signals immediately
# instead of waiting 30-60 minutes for live data to accumulate
warmup:
  enabled: true                       # [bool] Enable historical warmup on startup
  bars_to_fetch: 100                  # [int] Number of bars to fetch per symbol (min 50 for most agents)
  bar_size: "1 min"                   # [string] Bar size: "1 min", "5 mins", "15 mins", "1 hour"
  max_concurrent: 5                   # [int] Max concurrent IB requests (IB limit: 6)
  timeout_seconds: 30.0               # [float] Timeout per symbol request

# =============================================================================
# === REVIEW CAREFULLY - Risk Management ===
# These settings protect your capital. Understand before changing.
# =============================================================================

# Risk Management (Capital Protection First) - IMPROVED MONEY MANAGEMENT
# VALIDATION: All values are percentages (0-100) or ratios as noted
risk:
  # Value at Risk limit - REDUCED after 25% loss incident
  max_portfolio_var_pct: 1.0          # [float] REDUCED from 2.0 to 1.0 for safety

  # EMERGENCY: Position size limits - aggressive reduction
  max_position_pct: 1.5               # [float] REDUCED from 2.5 to 1.5
  max_position_size_pct: 1.5          # [float] REDUCED from 2.5 to 1.5

  # Sector concentration limit
  max_sector_pct: 15.0                # [float] REDUCED from 20.0 to 15.0
  max_sector_exposure_pct: 15.0       # [float] REDUCED from 20.0 to 15.0

  # CRITICAL: Total gross exposure - HALVED
  max_gross_exposure_pct: 25.0        # [float] REDUCED from 50.0 to 25.0 (CRITICAL FIX)

  # Loss limits - TIGHTENED for capital preservation
  max_daily_loss_pct: 1.5             # [float] REDUCED from 3.0 to 1.5
  max_drawdown_pct: 7.0               # [float] REDUCED from 10.0 to 7.0

  # Per-position daily loss limit
  max_position_daily_loss_pct: 0.5    # [float] REDUCED from 1.0 to 0.5

  # Weekly loss limit (7-day rolling) - HARD STOP triggers kill-switch
  max_weekly_loss_pct: 5.0            # [float] 5% weekly loss triggers kill-switch

  # Rolling N-day drawdown - HARD STOP triggers kill-switch
  rolling_drawdown_days: 5            # [int] 5-day rolling window for drawdown
  max_rolling_drawdown_pct: 4.0       # [float] 4% rolling drawdown triggers kill-switch

  # Manual override requirement for severe loss events
  kill_switch_manual_override_required: true  # [bool] Require explicit confirmation to reset after weekly/rolling stops

  # CRITICAL: Tiered drawdown - MORE AGGRESSIVE RESPONSE
  drawdown:
    warning_pct: 2.0                  # [float] REDUCED from 3.0 - reduce sizes at 2%
    critical_pct: 3.0                 # [float] REDUCED from 5.0 - close worst 20% at 3%
    severe_pct: 5.0                   # [float] REDUCED from 8.0 - defensive mode at 5%
    maximum_pct: 7.0                  # [float] REDUCED from 10.0 - close all at 7%

  # Leverage limit (gross notional / net liquidation)
  # For futures, 3.0x gross is conservative since margin is only ~5% of notional
  max_leverage: 3.0                   # [float] Reasonable for futures (notional-based)

  # Order rate limits (anti-HFT, regulatory compliance)
  max_orders_per_minute: 10           # [int, 1-100] Orders per minute limit
  min_order_interval_ms: 100          # [int, 50-5000] Minimum ms between orders

# =============================================================================
# === ADVANCED - Contract and Futures Settings ===
# =============================================================================

# Contract Specifications
contract_specs:
  margin_buffer_pct: 10.0             # Additional margin buffer above exchange minimum

# Futures Roll Management
futures_roll:
  enabled: true
  auto_roll: true                     # Automatically generate roll signals
  default_roll_days_before: 5         # Days before expiry to start roll

# Correlation Management
correlation:
  lookback_days: 60                   # Rolling window for correlation
  max_pairwise_correlation: 0.85      # Alert threshold for high correlation
  min_history_days: 20                # Minimum data for calculation
  regime_change_threshold: 0.15       # Sensitivity for regime detection

# Enhanced VaR Settings
var:
  method: "all"                       # "parametric", "historical", "monte_carlo", or "all"
  confidence_level: 0.95              # 95% confidence for VaR
  horizon_days: 1                     # 1-day VaR
  monte_carlo_simulations: 10000      # Number of MC simulations
  ewma_decay_factor: 0.94             # EWMA decay for volatility

# Stress Testing
stress_testing:
  enabled: true
  max_scenario_loss_pct: 25.0         # Maximum acceptable scenario loss
  margin_buffer_pct: 20.0             # Margin buffer requirement
  run_on_startup: false               # Run stress tests at startup

# Greeks Limits (Options Risk)
greeks:
  max_portfolio_delta: 500            # Maximum portfolio delta
  max_portfolio_gamma: 100            # Maximum portfolio gamma
  max_portfolio_vega: 50000           # Maximum portfolio vega
  max_portfolio_theta: -10000         # Maximum (most negative) theta

# Liquidity Risk
liquidity:
  max_position_pct_of_adv: 10.0       # Position must be < 10% of ADV
  max_order_pct_of_adv: 5.0           # Order must be < 5% of ADV

# Position Sizing - IMPROVED MONEY MANAGEMENT
position_sizing:
  method: "kelly"                     # "kelly", "vol_target", "fixed_fractional", "equal"
  # IMPROVED: Use quarter-Kelly (0.25x) instead of half-Kelly for safer sizing
  kelly_fraction: 0.25                # [float, 0.1-0.5] Fractional Kelly multiplier
  # IMPROVED: Cap raw Kelly before applying fraction to prevent outsized positions
  max_kelly_raw: 0.15                 # [float, 0.1-0.3] Max raw Kelly before fraction (15%)
  # IMPROVED: Stricter position size limits
  max_position_pct: 3.0               # [float, 1.0-10.0] Maximum position as % of portfolio
  min_position_pct: 0.5               # [float, 0.1-2.0] Minimum position as % of portfolio
  # IMPROVED: Total exposure limit
  max_total_exposure_pct: 50.0        # [float, 25.0-100.0] Maximum total portfolio exposure %
  vol_target: 0.15                    # Target volatility (15% annual)
  correlation_discount: true          # Reduce size for correlated positions

# Cross-Strategy Risk Budget (#P3)
risk_budget:
  enabled: true
  allocation_method: "risk_parity"    # "equal", "risk_parity", "performance_weighted", "fixed", "drawdown_adjusted"
  total_risk_budget_pct: 2.0          # Total portfolio risk budget (% of NAV)
  rebalance_drift_threshold: 0.20     # Rebalance if drift > 20% from target
  rebalance_time_interval_hours: 24   # Check time-based rebalancing daily
  strategy_max_drawdown: 0.10         # Max 10% drawdown per strategy before freeze
  sharpe_freeze_threshold: -0.5       # Freeze strategy if Sharpe < -0.5
  vol_scaling_enabled: true           # Scale down budget in high vol
  high_vol_threshold: 0.30            # 30% vol is "high"
  high_vol_reduction: 0.50            # Reduce budget by 50% in high vol
  # Fixed allocations (used when method="fixed")
  fixed_allocations:
    MacroAgent: 0.10
    StatArbAgent: 0.15
    MomentumAgent: 0.15
    MarketMakingAgent: 0.10
    MACDvAgent: 0.15
    SentimentAgent: 0.15
    ChartAnalysisAgent: 0.20

# =============================================================================
# === DANGEROUS - Regulatory Compliance ===
# Changing these may violate EU regulations. Consult compliance officer.
# =============================================================================

# Market Surveillance (MAR 2014/596/EU)
surveillance:
  wash_trading_detection: true
  spoofing_detection: true
  quote_stuffing_detection: true
  layering_detection: true
  wash_trading_window_seconds: 60
  spoofing_cancel_threshold: 0.8      # 80% cancel rate triggers alert
  quote_stuffing_rate_per_second: 10

# Best Execution (RTS 27/28)
best_execution:
  benchmark: "vwap"                   # "arrival", "vwap", "twap"
  slippage_alert_bps: 50              # Alert if slippage exceeds 50bps
  report_retention_quarters: 8        # Keep 8 quarters of data

# Transaction Reporting (ESMA RTS 22/23)
# IMPORTANT: You MUST obtain a valid LEI (Legal Entity Identifier) from a
# GLEIF-registered LOU before production. Get your LEI at: https://www.gleif.org/
# The placeholder below will be rejected and transaction reporting will be disabled.
transaction_reporting:
  enabled: true
  reporting_deadline_minutes: 15      # Report within 15 minutes
  # REQUIRED FOR PRODUCTION: Your 20-character LEI
  # Get yours at: https://www.gleif.org/en/about-lei/get-an-lei-find-lei-issuing-organizations
  # Example format: 5493006MHB84DD0ZWV18
  firm_lei: "529900T8BM49AURSDO55"   # Same LEI as compliance section
  firm_country: "FR"                  # France (AMF jurisdiction)
  default_venue: "XPAR"               # Paris exchange MIC

# Compliance (EU/AMF Compatible)
compliance:
  jurisdiction: "EU"
  regulator: "AMF"
  firm_lei: "529900T8BM49AURSDO55"    # [string, 20 chars] Legal Entity Identifier (paper trading placeholder)
  require_rationale: true             # All decisions must have rationale
  audit_retention_days: 2555          # 7 years as per MiFID II
  banned_instruments: []              # Instruments we cannot trade
  allowed_asset_classes:
    - "equity"
    # - "etf"  # ETF trading disabled
    - "option"
    - "future"
    - "forex"
    - "commodity"

# =============================================================================
# === SAFE TO MODIFY - Logging and Monitoring ===
# =============================================================================

# Logging & Audit
# SAFE: Adjust log level as needed (DEBUG, INFO, WARNING, ERROR)
logging:
  level: "INFO"
  format: "%(asctime)s | %(name)s | %(levelname)s | %(message)s"
  audit_file: "logs/audit.jsonl"
  trade_file: "logs/trades.jsonl"
  decision_file: "logs/decisions.jsonl"

# Health Check Server (separate from dashboard on port 8080)
health_check:
  enabled: true
  host: "127.0.0.1"
  port: 8080  # Health check on 8080, dashboard on 8081
  max_event_queue_pct: 90.0
  max_latency_ms: 1000.0
  min_active_agents: 3
  broker_required: false

# Monitoring & Observability
monitoring:
  log_dir: "logs/agents"
  metrics_history_size: 10000
  metrics_retention_hours: 24
  anomaly_zscore_threshold: 3.0
  anomaly_min_samples: 30
  alert_thresholds:
    daily_pnl_pct:
      warning: -2.0
      critical: -3.0
    drawdown_pct:
      warning: 5.0
      critical: 10.0
    latency_ms:
      warning: 500
      critical: 1000
    var_95_pct:
      warning: 1.5
      critical: 2.0

# =============================================================================
# === SAFE TO MODIFY - Sector Mappings ===
# Add your instruments here with their sector classification
# =============================================================================

# Sector Mapping for Risk Management
sector_map:
  # Equities
  AAPL: "technology"
  MSFT: "technology"
  GOOGL: "technology"
  AMZN: "consumer_discretionary"
  META: "technology"
  NVDA: "technology"
  TSLA: "consumer_discretionary"
  # ETFs
  SPY: "index"
  QQQ: "index"
  IWM: "index"
  # Micro Futures - Index
  MES: "index_futures"
  MNQ: "index_futures"
  MYM: "index_futures"
  M2K: "index_futures"
  # Micro Futures - Energy
  MCL: "energy"
  # Micro Futures - Metals
  MGC: "precious_metals"

# =============================================================================
# === SAFE TO MODIFY - Portfolio Settings ===
# =============================================================================

portfolio:
  initial_capital: 757243.0           # [float] Starting capital in USD - reset to match IB account
  base_currency: "USD"                # [string] Base currency for reporting

# =============================================================================
# === SAFE TO MODIFY - Strategy Configuration ===
# =============================================================================

strategies:
  enabled:                            # [list] Strategies to activate
    - "momentum"
    - "stat_arb"
    - "market_making"
  weights:                            # Strategy allocation weights (must sum to 1.0)
    momentum: 0.4
    stat_arb: 0.4
    market_making: 0.2

# =============================================================================
# === REVIEW CAREFULLY - CIO Autonomous Position Management ===
# These settings control how the CIO manages existing positions
# =============================================================================

# CIO Position Management Configuration
# Enables autonomous decision-making for position exit/reduction
cio:
  position_management_enabled: true   # [bool] Enable autonomous position management
  position_review_interval_seconds: 30  # [int] How often to review positions (was 60, Phase 12)

  position_management:
    # Loss thresholds - when to close losing positions
    max_loss_pct: 2.0                 # [float] INTRADAY: Close at 2% loss (was 5%)
    extended_loss_pct: 3.0            # [float] INTRADAY: Emergency close at 3% (was 8%)
    loss_time_threshold_hours: 2.0    # [float] INTRADAY: Close losers after 2h (was 48h)

    # Profit taking thresholds (Phase 12: realistic for intraday futures)
    profit_target_pct: 1.5            # [float] INTRADAY: Take profit at 1.5% (was 4%)
    trailing_profit_pct: 0.75         # [float] INTRADAY: Trail 0.75% from peak (was 1.5%)
    partial_profit_pct: 33.0          # [float] Percentage to sell at each partial level (was 50)

    # Conviction-based position reduction
    conviction_drop_threshold: 0.3    # [float] Reduce position if conviction drops by this %
    min_conviction_to_hold: 0.5       # [float] INCREASED from 0.4 - exit faster on weak conviction

    # Time-based rules (Phase 12: per-strategy-type holding limits)
    max_holding_days: 0.25            # [float] INTRADAY: Max 6h holding (was 2 days)
    stale_signal_hours: 4.0           # [float] INTRADAY: Stale after 4h (was 12h)
    max_holding_hours_intraday: 3.0   # [float] Session/TTM/MeanReversion/EventDriven (was 4h)
    max_holding_hours_swing: 4.0      # [float] INTRADAY: All strategies max 4h (was 48h)
    max_holding_hours_pairs: 4.0      # [float] INTRADAY: Pairs max 4h too (was 120h)

    # Market regime adjustments
    volatile_regime_loss_pct: 3.0     # [float] Tighter stop in volatile markets
    trending_regime_profit_mult: 1.5  # [float] Let profits run longer in trending markets

    # Stop-loss override rules
    allow_stop_override_in_trending: true  # [bool] Allow CIO to override stops in strong trends
    stop_override_min_conviction: 0.8 # [float] Min conviction to override a stop-loss

    # Phase 12: Active Position Protection (breakeven + trailing + graduated exits)
    breakeven_r_trigger: 1.0          # [float] Move stop to breakeven at this R-multiple
    breakeven_buffer_pct: 0.1         # [float] Buffer above entry for spread (0.1%)
    trailing_activation_r: 1.0        # [float] INTRADAY: Activate trailing at 1R (was 1.5R)
    trailing_distance_r: 0.3          # [float] INTRADAY: Trail 0.3R behind peak (was 0.5R)
    partial_profit_1_r: 1.0           # [float] INTRADAY: 1st partial at 1R (was 1.5R)
    partial_profit_2_r: 1.5           # [float] INTRADAY: 2nd partial at 1.5R (was 2.5R)
    partial_profit_3_r: 2.0           # [float] INTRADAY: Full exit at 2R (was 3.5R)

  # Signal Quality Scoring (Phase 2 Enhancement)
  # Filters out low-quality signals before aggregation
  signal_quality:
    enabled: true                       # [bool] Enable signal quality scoring
    min_total_score: 50.0               # [float] Reject signals below this score (0-100)
    min_volume_score: 5.0               # [float] Min volume confirmation score (0-20)
    min_trend_score: 5.0                # [float] Min trend alignment score (0-20)

  # Enhanced Correlation Filter (Phase D Enhancement)
  # Monthly rolling correlation with aggressive weight reduction
  correlation:
    use_signal_correlation_adjustment: true   # [bool] Enable correlation-based weight adjustment
    signal_correlation_lookback: 50           # [int] Short-term lookback (signals)
    monthly_correlation_lookback: 720         # [int] Monthly lookback (30 days hourly)
    high_correlation_threshold: 0.95          # [float] Halve weight above this correlation
    high_correlation_weight_factor: 0.5       # [float] Weight multiplier for highly correlated signals
    monthly_correlation_update_interval_hours: 1.0  # [float] How often to update monthly correlations

# =============================================================================
# === SAFE TO MODIFY - Trading Universe ===
# Add or remove instruments you want to trade
# =============================================================================

# Universe of Instruments
universe:
  equities:
    - symbol: "AAPL"
      exchange: "SMART"
      currency: "USD"
    - symbol: "MSFT"
      exchange: "SMART"
      currency: "USD"
    - symbol: "GOOGL"
      exchange: "SMART"
      currency: "USD"
    - symbol: "AMZN"
      exchange: "SMART"
      currency: "USD"
    - symbol: "META"
      exchange: "SMART"
      currency: "USD"
    - symbol: "NVDA"
      exchange: "SMART"
      currency: "USD"
    - symbol: "TSLA"
      exchange: "SMART"
      currency: "USD"

  etfs:
    - symbol: "SPY"
      exchange: "SMART"
      currency: "USD"
    - symbol: "QQQ"
      exchange: "SMART"
      currency: "USD"
    - symbol: "IWM"
      exchange: "SMART"
      currency: "USD"
    - symbol: "GLD"        # Gold ETF
      exchange: "SMART"
      currency: "USD"
    - symbol: "USO"        # Oil ETF
      exchange: "SMART"
      currency: "USD"

  # Futures - Micro contracts only (limited account for live testing)
  futures:
    # Micro Index Futures (1/10th of E-mini)
    - symbol: "MES"        # Micro E-mini S&P 500
      exchange: "CME"
      currency: "USD"
    - symbol: "MNQ"        # Micro E-mini NASDAQ 100
      exchange: "CME"
      currency: "USD"
    - symbol: "MYM"        # Micro E-mini Dow
      exchange: "CBOT"
      currency: "USD"
    - symbol: "M2K"        # Micro E-mini Russell 2000
      exchange: "CME"
      currency: "USD"

    # Micro Energy
    - symbol: "MCL"        # Micro WTI Crude Oil
      exchange: "NYMEX"
      currency: "USD"

    # Micro Metals
    - symbol: "MGC"        # Micro Gold
      exchange: "COMEX"
      currency: "USD"

  # Forex (cash pairs)
  forex:
    - symbol: "EUR"        # EUR/USD
      exchange: "IDEALPRO"
      currency: "USD"
    - symbol: "GBP"        # GBP/USD
      exchange: "IDEALPRO"
      currency: "USD"
    - symbol: "JPY"        # USD/JPY (quoted as JPY)
      exchange: "IDEALPRO"
      currency: "JPY"
    - symbol: "CHF"        # USD/CHF
      exchange: "IDEALPRO"
      currency: "CHF"
    - symbol: "AUD"        # AUD/USD
      exchange: "IDEALPRO"
      currency: "USD"

# =============================================================================
# === REVIEW CAREFULLY - Agent Configuration ===
# Strategy parameters - changes affect trading behavior
# =============================================================================

# Agent-Specific Configuration
agents:
  # ========== SIGNAL AGENTS ==========
  macro:
    enabled: true                       # RE-ENABLED - now has per-position TP/SL (2% SL, 4% TP)
    indicators:
      - "yield_curve"
      - "vix"
      - "dxy"
    rebalance_frequency: "daily"

  stat_arb:
    enabled: true
    lookback_days: 60
    zscore_entry_threshold: 2.0
    zscore_exit_threshold: 0.5
    pairs:
      - ["AAPL", "MSFT"]
      - ["GOOGL", "META"]
      - ["MES", "MNQ"]     # Micro index futures pair
      - ["MGC", "MCL"]     # Micro metals/energy pair
    # Correlation divergence detection (MoonDev-inspired)
    divergence_enabled: true
    divergence_threshold: 2.0           # Z-score threshold for divergence signal
    divergence_lookback: 20             # Periods for correlation calculation
    correlation_breakdown_threshold: 0.3 # Drop in correlation to trigger alert
    divergence_pairs:                   # Pairs to monitor for divergence
      - ["SPY", "QQQ"]    # Index ETFs (data only)
      - ["MES", "MNQ"]    # Micro index futures
      - ["MGC", "MCL"]    # Micro metals/energy
      - ["AAPL", "MSFT"]  # Tech leaders

  momentum:
    enabled: true
    fast_period: 10
    slow_period: 30
    signal_period: 9
    rsi_period: 14
    rsi_overbought: 70
    rsi_oversold: 30

    # =========================================================================
    # QUICK WIN #1: Asset-specific MA periods (from research)
    # =========================================================================
    asset_configs:
      futures:
        fast_period: 9
        slow_period: 21
        trend_filter_period: 200
        use_ema: true
      forex:
        fast_period: 5
        slow_period: 13
        trend_filter_period: 200
        use_ema: true
      equities:
        fast_period: 20
        slow_period: 50
        trend_filter_period: 200
        use_ema: false  # SMA for equities
      commodities:
        fast_period: 20
        slow_period: 50
        trend_filter_period: 200
        use_ema: true

    # =========================================================================
    # QUICK WIN #2: Asset-specific RSI thresholds (wider for volatile assets)
    # =========================================================================
    rsi_overrides:
      MNQ: { overbought: 75, oversold: 25 }
      M2K: { overbought: 75, oversold: 25 }
      NG: { overbought: 80, oversold: 20 }
      SI: { overbought: 75, oversold: 25 }
      GBPUSD: { overbought: 85, oversold: 15 }
      GC: { overbought: 60, oversold: 40, use_midband: true }
      MGC: { overbought: 60, oversold: 40, use_midband: true }

    # =========================================================================
    # QUICK WIN #6: Triple confirmation filter
    # =========================================================================
    use_triple_confirmation: true
    min_confirmations: 2  # Require 2 of 3 indicators (RSI, MACD, Stoch)
    confirmation_boost: true  # Boost conviction when all 3 align

    # =========================================================================
    # QUICK WIN #8: MACD settings by timeframe (research-optimized)
    # =========================================================================
    macd_fast_period: 12
    macd_slow_period: 26
    macd_signal_period: 9
    macd_by_timeframe:
      scalping_1m_5m:
        fast: 3
        slow: 10
        signal: 16
      day_trading_5m_15m:
        fast: 5
        slow: 35
        signal: 5  # Research-optimized for futures
      day_trading_15m_1h:
        fast: 8
        slow: 17
        signal: 9
      swing_daily:
        fast: 12
        slow: 26
        signal: 9

    # =========================================================================
    # QUICK WIN #10: ADX filter for trend trades
    # =========================================================================
    adx_period: 14
    adx_strong_threshold: 25      # Strong trend
    adx_moderate_threshold: 20    # Moderate trend
    adx_weak_threshold: 15        # Weak/ranging
    require_strong_trend: true    # Only trade with ADX > 25
    allow_moderate_trend: true    # Allow with reduced size
    suppress_weak_trend: true     # Block signals when ADX < 20

    # Demand/Supply zone detection (MoonDev-inspired)
    demand_zones_enabled: true
    zone_lookback: 50                   # Candles to analyze for zones
    zone_touch_threshold: 0.02          # 2% zone width
    candle_period_seconds: 300          # 5-minute candles for zone detection

  market_making:
    enabled: false                       # DISABLED: Requires real-time level 2 data, degraded with delayed data
    spread_bps: 10
    max_inventory: 1000
    quote_refresh_ms: 1000

  # LLM-powered news sentiment analysis
  sentiment:
    enabled: false                      # DISABLED BY DEFAULT - uses Claude API tokens
    llm_provider: "anthropic"           # "anthropic" or "openai"
    model: "claude-sonnet-4-5-20250929"   # Claude Sonnet 4 for sentiment analysis
    news_sources:
      - "https://www.investing.com/rss/news.rss"
      - "https://feeds.marketwatch.com/marketwatch/topstories/"
    analysis_interval_seconds: 300      # Analyze every 5 minutes
    max_news_age_hours: 24              # Only consider news < 24h old
    min_confidence: 0.5                 # Minimum confidence for signal
    calls_per_minute: 20                # Rate limit for LLM API
    timeout_seconds: 10                 # API timeout

  # Claude Vision chart pattern analysis
  chart_analysis:
    enabled: false                      # DISABLED BY DEFAULT - uses Claude API tokens
    model: "claude-sonnet-4-5-20250929"   # Vision-capable model
    symbols:                            # Symbols to analyze
      - "AAPL"
      - "MSFT"
      - "NVDA"
    analysis_interval_seconds: 300      # Analyze every 5 minutes
    candle_count: 50                    # Number of candles to display
    chart_timeframe: "15min"            # Candle timeframe
    min_confidence: 0.5                 # Minimum confidence for signal
    timeout_seconds: 30                 # API timeout (longer for vision)

  # LLM-powered price forecasting (alphaswarm-inspired)
  forecasting:
    enabled: false                      # DISABLED BY DEFAULT - uses Claude API tokens
    forecast_horizons:                  # Timeframes to forecast
      - "1h"
      - "4h"
    min_confidence: 0.6                 # Minimum confidence to generate signal
    forecast_interval_seconds: 300      # Minimum time between forecasts
    price_history_length: 100           # Price points to keep for context
    symbols:                            # Symbols to forecast
      - "AAPL"
      - "MSFT"
      - "MES"
      - "MNQ"
    llm:
      llm_provider: "anthropic"
      model: "claude-sonnet-4-5-20250929"  # Claude Sonnet 4 for forecasts
      calls_per_minute: 20
      timeout_seconds: 15

  # ========== PHASE 6 AGENTS (New Strategies) ==========
  session:
    enabled: true                        # ENABLED: Fixed agent-strategy interface
    opening_range_minutes: 30            # First 30 min after open
    breakout_threshold_atr: 0.5          # Breakout distance in ATR
    session_momentum_enabled: true
    symbols:
      - "MES"
      - "MNQ"

  index_spread:
    enabled: true                        # ENABLED: Fixed agent-strategy interface
    spread_pairs:
      - ["MES", "MNQ"]                   # Micro S&P vs Micro NASDAQ
      - ["MYM", "M2K"]                   # Micro Dow vs Micro Russell
    zscore_entry: 2.0
    zscore_exit: 0.5
    lookback_periods: 20

  ttm_squeeze:
    enabled: true                        # ENABLED: Fixed agent-strategy interface
    bb_length: 20
    bb_mult: 2.0
    kc_length: 20
    kc_mult: 1.5
    momentum_length: 12
    symbols:
      - "MES"
      - "MNQ"

  event_driven:
    enabled: true                        # ENABLED: Fixed to use analyze_event() and generate_signal()
    events:
      - "FOMC"
      - "NFP"
      - "CPI"
    pre_event_hours: 24                  # Hours before event to analyze
    post_event_hours: 4                  # Hours after event to trade
    min_volatility_increase: 1.5         # 50% vol increase threshold

  mean_reversion:
    enabled: true                        # ENABLED: Fixed agent-strategy interface
    rsi_period: 14
    rsi_oversold: 30
    rsi_overbought: 70
    bb_period: 20
    bb_std: 2.0
    zscore_threshold: 2.0
    lookback_periods: 50
    symbols:
      - "MES"
      - "MNQ"
      - "AAPL"
      - "MSFT"

  # MACD-v Agent (Volatility-Normalized MACD) - Charles H. Dow Award 2022
  macdv:
    enabled: true                        # ENABLED: Award-winning indicator
    # MACD-v parameters
    fast_period: 12                      # Fast EMA period
    slow_period: 26                      # Slow EMA period
    signal_period: 9                     # Signal line EMA period
    atr_period: 26                       # ATR period for normalization
    # Zone thresholds (volatility-normalized)
    overbought_zone: 150.0               # Standard overbought zone
    oversold_zone: -150.0                # Standard oversold zone
    extreme_overbought: 200.0            # Extreme overbought zone
    extreme_oversold: -200.0             # Extreme oversold zone
    # Signal generation
    require_zone_exit: true              # Require price to exit zone for signal
    min_confidence: 0.75                 # Minimum confidence threshold
    # Stop-loss / Take-profit (ATR-based)
    use_atr_stop: true                   # Use ATR for stops
    stop_loss_atr_mult: 1.0              # INTRADAY: Stop at 1x ATR (was 2x)
    take_profit_atr_mult: 1.5            # INTRADAY: TP at 1.5x ATR (was 4x)
    stop_loss_pct: 1.0                   # INTRADAY: 1% stop (was 2%)
    take_profit_pct: 1.5                 # INTRADAY: 1.5% TP (was 4%)
    # Histogram momentum
    histogram_momentum_bars: 3           # Bars to check for momentum confirmation
    # Symbols to analyze
    symbols:
      - "MES"
      - "MNQ"
      - "M2K"
      - "MYM"
      - "AAPL"
      - "MSFT"
      - "NVDA"
      - "MGC"
      - "MCL"

  # ========== EXIT RULES (TakeProfit/StopLoss) ==========
  # CRITICAL: Position-level stop-loss management for 100% automation
  # The system closes INDIVIDUAL losing positions instead of emergency shutdown
  exit_rules:
    enabled: true
    # Stop-loss settings
    use_atr_stops: true                  # Use ATR-based dynamic stops (recommended)
    stop_loss_atr_multiplier: 1.5        # INTRADAY: Stop at 1.5x ATR (was 2.0)
    default_stop_loss_pct: 1.0           # INTRADAY: 1% stop (was 3%)
    # Take profit settings
    default_take_profit_pct: 1.5         # INTRADAY: 1.5% target (was 4%)
    trailing_take_profit: true           # Trailing take profit enabled
    # Trailing stop settings (Phase 12: tighter for intraday)
    trailing_enabled: true               # Enable trailing stops to lock in gains
    trailing_activation_pct: 0.5         # INTRADAY: Activate at 0.5% (was 1%)
    trailing_distance_pct: 0.75          # INTRADAY: Trail 0.75% (was 1.5%)
    # Time-based exit
    time_exit_hours: 4                   # INTRADAY: Max 4h hold (was 48h)

  # ========== DECISION & VALIDATION AGENTS ==========
  cio:
    signal_weight_macro: 0.10
    signal_weight_stat_arb: 0.12
    signal_weight_momentum: 0.12
    signal_weight_market_making: 0.08
    signal_weight_macdv: 0.10            # MACD-v volatility-normalized momentum
    # Phase 6 agents
    signal_weight_session: 0.10          # Session-based trading (ORB)
    signal_weight_index_spread: 0.10     # MES/MNQ spread trading
    signal_weight_ttm_squeeze: 0.08      # TTM Squeeze volatility breakout
    signal_weight_event_driven: 0.08     # FOMC/NFP/CPI events
    signal_weight_mean_reversion: 0.10   # RSI/BB/Z-score mean reversion
    # LLM agents (disabled by default - consume API tokens)
    signal_weight_sentiment: 0.10       # LLM sentiment analysis weight
    signal_weight_chart_analysis: 0.10  # Claude Vision chart patterns
    signal_weight_forecasting: 0.10     # LLM price forecasting
    min_conviction_threshold: 0.70      # INTRADAY: Require stronger conviction (was 0.50)
    max_concurrent_decisions: 5
    max_open_positions: 6               # INTRADAY: Max 6 simultaneous positions
    decision_cooldown_seconds: 120.0    # INTRADAY: 2min cooldown per symbol
    max_leverage: 3.0                   # Must match RiskAgent's max_leverage (both 3.0x)
    # Dynamic weight settings
    use_dynamic_weights: true
    performance_weight_factor: 0.3
    regime_weight_factor: 0.2
    # Position sizing
    use_kelly_sizing: true
    kelly_fraction: 0.5               # Half-Kelly
    base_position_size: 100
    max_position_size: 1000

  execution:
    default_algo: "TWAP"
    slice_interval_seconds: 60
    max_slippage_bps: 50

  risk_compliance:
    check_interval_seconds: 1.0
    emergency_liquidation: false

  # Surveillance agent
  surveillance:
    enabled: true

  # Transaction reporting agent
  transaction_reporting:
    enabled: true

# Performance Attribution
attribution:
  rolling_window_days: 30
  risk_free_rate: 0.05                # 5% annual

# Seasonality Strategy
seasonality:
  enabled: true
  min_win_rate: 0.55                  # Minimum historical win rate
  min_patterns: 1                     # Minimum confirming patterns

# =============================================================================
# === QUICK WINS - Research-Based Optimizations ===
# =============================================================================

# =========================================================================
# QUICK WIN #3: Session-Based Trading Windows
# =========================================================================
trading_sessions:
  forex:
    eurusd:
      active_sessions: ["london", "ny_overlap"]
      london_start: "08:00"   # UTC
      london_end: "17:00"
      ny_overlap_start: "13:00"
      ny_overlap_end: "17:00"
      avoid: ["asian"]  # Low liquidity for EUR/USD
    usdjpy:
      active_sessions: ["asian", "london", "ny"]
    gbpusd:
      active_sessions: ["london", "ny_overlap"]
      avoid: ["asian"]

  futures:
    es_mes:
      optimal_hours: ["09:30-11:30", "14:00-16:00"]  # ET
      avoid_hours: ["12:00-14:00"]  # Lunch lull
    nq_mnq:
      optimal_hours: ["09:30-11:30", "14:00-16:00"]
      avoid_hours: ["12:00-14:00"]

  commodities:
    cl_mcl:  # Crude oil
      optimal_hours: ["09:00-14:30"]  # NYMEX pit overlap
    gc_mgc:  # Gold
      optimal_hours: ["08:00-12:00", "13:30-17:00"]  # London + NY
    ng:
      optimal_hours: ["09:30-14:00"]  # High volume

# =========================================================================
# QUICK WIN #4: ATR Multiplier Scaling by Volatility Regime
# =========================================================================
stop_loss_scaling:
  base_atr_multiplier: 2.5
  high_vol_threshold: 1.5      # Current/historical ATR ratio
  low_vol_threshold: 0.7
  high_vol_multiplier: 1.3     # 3.25x ATR in high vol
  low_vol_multiplier: 0.8      # 2.0x ATR in low vol
  # Asset-specific ATR multipliers
  atr_overrides:
    MES: 1.5
    MNQ: 2.0  # More volatile
    CL: 2.5
    NG: 3.0   # Very volatile
    GC: 2.0
    EURUSD: 1.5

# =========================================================================
# QUICK WIN #5: Risk-Reward Minimum Filter
# =========================================================================
signals:
  min_risk_reward_ratio: 2.0  # Minimum 2:1 R:R for all signals
  rr_overrides:
    scalping: 1.5       # Lower R:R acceptable (higher win rate)
    swing: 2.0          # Standard swing trading
    position: 3.0       # Higher R:R for position trades

# =========================================================================
# QUICK WIN #7: Turn-of-Month Effect
# =========================================================================
position_sizing:
  method: "kelly"
  kelly_fraction: 0.25
  max_kelly_raw: 0.15
  max_position_pct: 1.0               # INTRADAY: Max 1% per position (was 3%)
  min_position_pct: 0.5
  max_total_exposure_pct: 20.0        # INTRADAY: Max 20% total exposure (was 50%)
  vol_target: 0.15
  correlation_discount: true
  # Turn of month boost
  use_turn_of_month_boost: true
  tom_multiplier: 1.25          # 25% larger positions during TOM
  tom_asset_classes: ["equity", "future"]  # Apply to equities/futures only

# =========================================================================
# QUICK WIN #9: Spread/Slippage Pre-Check
# =========================================================================
execution:
  default_algo: "TWAP"
  slice_interval_seconds: 60
  max_slippage_bps: 50
  # Dynamic spread limits
  max_spread_atr_pct: 0.10      # Max spread as % of ATR
  spread_limits:
    ES: 0.05    # ES very liquid
    MES: 0.05
    EURUSD: 0.05
    NQ: 0.05
    MNQ: 0.06
    NG: 0.15    # NG wider spreads normal
    CL: 0.08
    GC: 0.07

  # Zombie order management (Phase C improvement)
  # Orders pending longer than timeout are automatically cancelled
  zombie_order_timeout_seconds: 30.0    # [float] Cancel orders older than this
  zombie_check_interval_seconds: 5.0    # [float] How often to check for zombies
  order_timeout_seconds: 300            # [float] General order timeout (5 min)
  algo_timeout_seconds: 3600            # [float] TWAP/VWAP algo timeout (1 hour)

# =============================================================================
# === PHASE C - Reconciliation Agent ===
# Position reconciliation for live trading safety
# =============================================================================
reconciliation:
  enabled: true                         # [bool] Enable reconciliation agent
  interval_seconds: 60.0                # [float] How often to reconcile (1 min)
  auto_correct: false                   # [bool] Auto-correct discrepancies (DANGER)
  discrepancy_threshold_pct: 1.0        # [float] Alert if >1% quantity mismatch
  cost_basis_threshold_pct: 5.0         # [float] Alert if >5% cost basis drift

# =============================================================================
# === PHASE C - State Persistence ===
# Hot restart capability - saves CIO state to disk
# =============================================================================
state_persistence:
  enabled: true                         # [bool] Enable state persistence
  state_dir: "state"                    # [string] Directory for state files
  cio_state_file: "cio_state.json"      # [string] CIO state filename
  max_backups: 5                        # [int] Number of backup files to keep
  auto_save_interval_seconds: 60.0      # [float] Auto-save interval
  max_recent_decisions: 100             # [int] Max decisions to store

# =============================================================================
# === PHASE B - Async Signal Cache ===
# Out-of-band processing for heavy agents
# =============================================================================
async_signal_cache:
  enabled: true                         # [bool] Enable async cache
  max_staleness_seconds: 30.0           # [float] Signals older than this are stale
  confidence_decay_per_second: 0.02     # [float] 2% confidence decay per second
  min_confidence_floor: 0.1             # [float] Never decay below 10%
  max_history_per_agent: 100            # [int] History entries per agent
  cleanup_interval_seconds: 60.0        # [float] Cleanup interval

  # Agents using out-of-band processing (compute in background)
  async_agents:
    - MacroAgent                        # HMM regime detection
    - SentimentAgent                    # LLM sentiment (when enabled)
    - ForecastingAgent                  # LLM forecasting (when enabled)

# =============================================================================
# === PHASE D - Enhanced Correlation Filter ===
# Monthly rolling correlation for weight adjustment
# =============================================================================
# (These settings are under cio section, documented here for reference)
# cio:
#   monthly_correlation_lookback: 720   # 30 days hourly observations
#   high_correlation_threshold: 0.95    # Halve weight above this
#   high_correlation_weight_factor: 0.5 # Weight multiplier for high corr

# =============================================================================
# === PHASE E - Local LLM Support ===
# Run sentiment analysis locally without API costs
# =============================================================================
llm:
  # Backend options: "claude", "openai", "ollama", "llama_cpp"
  backend: "claude"                     # [string] Default backend

  # Cloud API settings (default)
  api_timeout_seconds: 10               # [int] API request timeout
  api_max_retries: 3                    # [int] Max retry attempts
  api_calls_per_minute: 20              # [int] Rate limit for cloud APIs

  # Ollama local server configuration
  # Install: https://ollama.ai/download
  # Run: ollama serve && ollama pull llama3:8b
  ollama:
    url: "http://localhost:11434"       # [string] Ollama server URL
    model: "llama3:8b"                  # [string] Model to use (phi3, mistral, etc)

  # llama.cpp local configuration
  # Install: pip install llama-cpp-python
  # Download model: https://huggingface.co/models?search=gguf
  llama_cpp:
    model_path: "models/llama-3-8b-q4.gguf"  # [string] Path to GGUF model
    n_gpu_layers: 35                    # [int] Layers to offload to GPU (0 for CPU only)
    n_ctx: 2048                         # [int] Context window size

# =============================================================================
# === PHASE 10 - Immutable Audit Ledger (MiFID II Compliance) ===
# Hash-chained event logging for regulatory compliance
# =============================================================================
immutable_ledger:
  enabled: true                         # [bool] Enable audit ledger
  storage_path: "logs/audit_ledger"     # [string] Directory for ledger files
  max_memory_entries: 10000             # [int] Max entries to keep in memory
  auto_flush_interval_seconds: 60.0     # [float] Flush to disk interval
  verification_interval_entries: 1000   # [int] Verify chain every N entries
  export_format: "jsonl"                # [string] Export format (jsonl, json)
  compress_exports: false               # [bool] Compress exported files

# =============================================================================
# === PHASE 10 - Capital Allocation Governor ===
# Regime-based capital allocation and drawdown management
# =============================================================================
capital_allocation_governor:
  enabled: true                         # [bool] Enable capital governor
  total_capital: 1000000.0              # [float] Total capital under management
  rebalance_threshold_pct: 5.0          # [float] Rebalance if drift exceeds this %
  min_rebalance_interval_minutes: 60.0  # [float] Minimum time between rebalances

  # Strategy base allocations (% of total capital)
  allocations:
    MacroAgent: 15.0
    MomentumAgent: 20.0
    StatArbAgent: 20.0
    MarketMakingAgent: 10.0
    MACDvAgent: 15.0
    SessionAgent: 5.0
    IndexSpreadAgent: 5.0
    TTMSqueezeAgent: 5.0
    MeanReversionAgent: 5.0

  # Drawdown thresholds for capital reduction
  drawdown_thresholds:
    warning_pct: 3.0                    # [float] Start reducing at 3% drawdown
    elevated_pct: 5.0                   # [float] Further reduction at 5%
    critical_pct: 8.0                   # [float] Aggressive reduction at 8%
    severe_pct: 10.0                    # [float] Minimal exposure at 10%

# =============================================================================
# === PHASE 10 - Human-in-the-Loop Mode ===
# Queue decisions for human approval
# =============================================================================
human_in_the_loop:
  enabled: false                        # [bool] Start in human approval mode
  timeout_seconds: 300.0                # [float] Decision expires after 5 min
  max_pending_decisions: 100            # [int] Max queued decisions before eviction
  auto_expire: true                     # [bool] Auto-expire decisions after timeout
  notify_via_dashboard: true            # [bool] Show pending decisions in dashboard
  require_2fa: false                    # [bool] Require 2-factor for approval

# =============================================================================
# === PHASE 10 - IB Failure Simulator (Testing Only) ===
# Simulate broker failure scenarios for resilience testing
# WARNING: Only enable in paper trading for testing!
# =============================================================================
ib_failure_simulator:
  enabled: false                        # [bool] DANGER: Only enable for testing
  seed: 42                              # [int] Random seed for reproducibility

  # Scenario probabilities (0.0 to 1.0)
  scenarios:
    order_accepted_no_fill: 0.0         # [float] Zombie order probability
    fill_without_callback: 0.0          # [float] Silent fill probability
    disconnect_during_cancel: 0.0       # [float] Disconnect on cancel
    partial_fill_disconnect: 0.0        # [float] Partial fill then disconnect
    duplicate_fill_callback: 0.0        # [float] Duplicate callback probability
    market_data_gap: 0.0                # [float] Market data gap probability
